name: Deploy Workflow

on:
    workflow_dispatch:
        inputs:
            action:
                description: "Select the deployment action"
                required: true
                default: "deploy"
                type: choice
                options:
                    - deploy # Deploy infrastructure and application
                    - destroy # Destroy infrastructure
            clean_registry:
                description: "Clean untagged images from the registry"
                required: false
                type: boolean
                default: false

jobs:
    check-context:
        runs-on: ubuntu-latest
        outputs:
            can_proceed: ${{ steps.check.outputs.can_proceed }}
            current_tag: ${{ steps.check.outputs.current_tag }}
            action_type: ${{ steps.check.outputs.action_type }}
        steps:
            - name: Check tag branch context
              id: check
              run: |
                  REF_TYPE="${{ github.ref_type }}"
                  BRANCH_NAME="${{ github.ref_name }}"
                  ACTION="${{ github.event.inputs.action }}"

                  echo "üîç GitHub Context:"
                  echo "  Ref Type: $REF_TYPE"
                  echo "  Ref Name: $BRANCH_NAME"
                  echo "  Action: $ACTION"

                  # Verify we're on a tag branch
                  if [[ "$REF_TYPE" != "tag" ]]; then
                      echo "‚ùå This workflow can only run on tag branches"
                      echo "Current ref type: $REF_TYPE (expected: 'tag')"
                      echo "can_proceed=false" >> $GITHUB_OUTPUT
                      exit 1
                  fi

                  echo "‚úÖ Running on tag branch: $BRANCH_NAME"
                  echo "can_proceed=true" >> $GITHUB_OUTPUT
                  echo "current_tag=$BRANCH_NAME" >> $GITHUB_OUTPUT
                  echo "action_type=$ACTION" >> $GITHUB_OUTPUT

    tf-destroy-application:
        uses: ./.github/workflows/job_terraform_infrastructure.yaml
        needs: check-context
        if: |
            needs.check-context.outputs.can_proceed == 'true' &&
            needs.check-context.outputs.action_type == 'destroy'
        with:
            terraform_action: "destroy"
            working_directory: "IaC/application"
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
            TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

    tf-destroy-cloud:
        uses: ./.github/workflows/job_terraform_infrastructure.yaml
        needs: tf-destroy-application
        if: |
            needs.tf-destroy-application.result == 'success'
        with:
            terraform_action: "destroy"
            working_directory: "IaC/cloud"
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
            TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

    tf-apply-cloud:
        uses: ./.github/workflows/job_terraform_infrastructure.yaml
        needs: check-context
        if: |
            needs.check-context.outputs.can_proceed == 'true' &&
            needs.check-context.outputs.action_type == 'deploy'
        with:
            terraform_action: "apply"
            working_directory: "IaC/cloud"
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
            TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

    get-tf-cloud-outputs:
        runs-on: ubuntu-latest
        needs: tf-apply-cloud
        if: |
            needs.tf-apply-cloud.result == 'success'
        outputs:
            registry_endpoint: ${{ steps.outputs.outputs.registry_endpoint }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "~1.13"
                  cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

            - name: Get Terraform Outputs
              id: outputs
              working-directory: IaC/cloud
              env:
                  TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
              run: |
                  echo "üîß Initializing Terraform..."
                  terraform init

                  echo "üìä Getting Terraform outputs..."

                  # Get registry endpoint
                  if terraform output registry_endpoint >/dev/null 2>&1; then
                      REGISTRY_ENDPOINT=$(terraform output -raw registry_endpoint)
                      echo "registry_endpoint=$REGISTRY_ENDPOINT" >> $GITHUB_OUTPUT
                      echo "‚úÖ Registry endpoint: $REGISTRY_ENDPOINT"
                  else
                      echo "registry_endpoint=N/A" >> $GITHUB_OUTPUT
                      echo "‚ö†Ô∏è Registry endpoint not found"
                  fi

    docker-build-push:
        uses: ./.github/workflows/job_docker_build_push.yaml
        needs: get-tf-cloud-outputs
        if: |
            needs.get-tf-cloud-outputs.result == 'success'
        with:
            release_tag: ${{ github.ref_name }}
            image_name: ${{ needs.get-tf-cloud-outputs.outputs.registry_endpoint }}/${{ vars.IMAGE_NAME }}
            clean_registry: ${{ github.event.inputs.clean_registry == 'true' }}
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    tf-apply-application:
        uses: ./.github/workflows/job_terraform_infrastructure.yaml
        needs: docker-build-push
        if: |
            needs.docker-build-push.result == 'success'
        with:
            terraform_action: "apply"
            working_directory: "IaC/application"
            env_vars: |
                TF_VAR_image_name=${{ vars.IMAGE_NAME }}
                TF_VAR_image_tag=${{ github.ref_name }}
                TF_VAR_api_base_path=${{ vars.API_HOST_URL_PROD }}
                TF_VAR_env=Production
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
            TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
