name: Docker Build and Push

on:
    workflow_call:
        inputs:
            release_tag:
                description: "Release tag (e.g., v1.0.0)"
                required: true
                type: string
            image_name:
                description: "Docker image name"
                required: true
                type: string
            clean_registry:
                description: "Clean untagged images from registry"
                required: false
                type: boolean
                default: false
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN:
                description: "DigitalOcean access token"
                required: true
        outputs:
            image_tag:
                description: "Generated image tag"
                value: ${{ jobs.docker-build-push.outputs.image_tag }}

jobs:
    docker-build-push:
        runs-on: ubuntu-latest
        outputs:
            image_tag: ${{ steps.build.outputs.image_tag }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Login to DigitalOcean Container Registry
              run: doctl registry login

            - name: Build and tag Docker image
              id: build
              run: |
                  SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
                  RELEASE_TAG="${{ inputs.release_tag }}"

                  echo "Building image with tags: $RELEASE_TAG, $SHORT_SHA, latest"

                  docker build \
                    --build-arg API_URL="${{ vars.API_URL_PROD }}" \
                    -t ${{ inputs.image_name }}:$RELEASE_TAG \
                    -t ${{ inputs.image_name }}:$SHORT_SHA \
                    -t ${{ inputs.image_name }}:latest \
                    .

                  echo "image_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

            - name: Push images to registry
              run: |
                  SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
                  RELEASE_TAG="${{ inputs.release_tag }}"

                  echo "Pushing images..."
                  docker push ${{ inputs.image_name }}:$RELEASE_TAG
                  docker push ${{ inputs.image_name }}:$SHORT_SHA
                  docker push ${{ inputs.image_name }}:latest

            - name: Clean untagged images from registry
              if: ${{ inputs.clean_registry }}
              run: |
                  echo "Starting garbage collection..."
                  doctl registry garbage-collection start --include-untagged-manifests || echo "Garbage collection failed or already running"
