name: Terraform Infrastructure

on:
    workflow_call:
        inputs:
            terraform_action:
                description: "Terraform action to perform"
                required: true
                type: string
                # format, validate, plan, apply, destroy
            working_directory:
                description: "Terraform working directory"
                required: false
                type: string
                default: "IaC/cloud-services"
        secrets:
            DIGITALOCEAN_ACCESS_TOKEN:
                description: "DigitalOcean access token"
                required: false # No requerido para format
            TF_API_TOKEN:
                description: "HCP Terraform Cloud API token"
                required: false # No requerido para format
        outputs:
            terraform_outputs:
                description: "All Terraform outputs in JSON format"
                value: ${{ jobs.terraform.outputs.terraform_outputs }}

jobs:
    terraform:
        runs-on: ubuntu-latest
        outputs:
            terraform_outputs: ${{ steps.outputs.outputs.terraform_outputs }}
        env:
            TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

        defaults:
            run:
                working-directory: ${{ inputs.working_directory }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "~1.13"
                  cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

            - name: Terraform Init
              if: inputs.terraform_action != 'format'
              run: terraform init

            - name: Terraform Format Check and Apply
              if: inputs.terraform_action == 'format'
              run: |
                  echo "ðŸŽ¨ Checking Terraform format..."

                  # Check format first
                  if terraform fmt -check -recursive; then
                      echo "âœ… All Terraform files are properly formatted"
                  else
                      echo "âš ï¸ Some Terraform files need formatting, applying format..."
                      terraform fmt -recursive
                      echo "âœ… Terraform formatting applied successfully"

                      # List formatted files
                      echo "ðŸ“ Files that were formatted:"
                      git diff --name-only || echo "No changes to show"
                  fi

            - name: Terraform Validate
              if: inputs.terraform_action == 'validate'
              run: |
                  echo "ðŸ” Validating Terraform configuration..."
                  terraform validate
                  echo "âœ… Terraform configuration is valid"

            - name: Terraform Plan
              if: inputs.terraform_action == 'plan' || inputs.terraform_action == 'apply'
              run: |
                  echo "ðŸ“‹ Creating Terraform plan..."
                  terraform plan -out=out.tfplan -detailed-exitcode
                  PLAN_EXIT_CODE=$?
                  
                  echo "plan_exit_code=$PLAN_EXIT_CODE" >> $GITHUB_ENV
                  
                  if [ $PLAN_EXIT_CODE -eq 0 ]; then
                      echo "ðŸ“ Plan created successfully - No changes detected"
                  elif [ $PLAN_EXIT_CODE -eq 2 ]; then
                      echo "ðŸ“ Plan created successfully - Changes detected"
                  else
                      echo "âŒ Plan failed with exit code $PLAN_EXIT_CODE"
                      exit 1
                  fi
                  
                  echo "âœ… Terraform plan completed"

            - name: Terraform Apply
              if: inputs.terraform_action == 'apply'
              run: |
                  if [ "$plan_exit_code" = "0" ]; then
                      echo "ï¿½ No changes detected in plan - Skipping apply"
                      echo "âœ… Infrastructure is already up to date"
                      echo "### âœ… Terraform Apply - No Changes" >> $GITHUB_STEP_SUMMARY
                      echo "No changes were detected in the Terraform plan. Infrastructure is already up to date." >> $GITHUB_STEP_SUMMARY
                  elif [ "$plan_exit_code" = "2" ]; then
                      echo "ï¿½ðŸš€ Applying Terraform plan with changes..."
                      terraform apply -auto-approve out.tfplan
                      echo "âœ… Terraform apply completed successfully"
                      echo "### âœ… Terraform Apply - Changes Applied" >> $GITHUB_STEP_SUMMARY
                      echo "Terraform plan contained changes and was applied successfully." >> $GITHUB_STEP_SUMMARY
                  else
                      echo "âŒ Invalid plan state - Cannot proceed with apply"
                      exit 1
                  fi

            - name: Terraform Destroy
              if: inputs.terraform_action == 'destroy'
              run: |
                  echo "ðŸ—‘ï¸ Destroying Terraform infrastructure..."
                  terraform destroy -auto-approve
                  echo "âœ… Terraform destroy completed successfully"

            - name: Get Terraform Outputs
              if: inputs.terraform_action == 'apply'
              id: outputs
              run: |
                  echo "ðŸ“Š Getting all Terraform outputs..."

                  # Verificar que hay outputs
                  if terraform output >/dev/null 2>&1; then
                      echo "ðŸŽ¯ Found Terraform outputs, processing..."

                      # Capturar TODOS los outputs como JSON para GitHub Actions (en una sola lÃ­nea)
                      OUTPUTS_JSON=$(terraform output -json | jq -c .)
                      echo "terraform_outputs=$OUTPUTS_JSON" >> $GITHUB_OUTPUT
                      
                      # Mostrar todos los outputs en el summary
                      echo "### ðŸŽ¯ Terraform Outputs" >> $GITHUB_STEP_SUMMARY
                      echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                      terraform output >> $GITHUB_STEP_SUMMARY
                      echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

                      echo "âœ… All outputs captured as JSON successfully"
                  else
                      echo "âš ï¸ No Terraform outputs found"
                      echo "terraform_outputs={}" >> $GITHUB_OUTPUT
                      echo "### âš ï¸ No Terraform Outputs" >> $GITHUB_STEP_SUMMARY
                      echo "No outputs were defined in the Terraform configuration." >> $GITHUB_STEP_SUMMARY
                  fi
